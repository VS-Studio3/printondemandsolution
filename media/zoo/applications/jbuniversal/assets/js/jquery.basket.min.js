/**
 * JBZoo is universal CCK based Joomla! CMS and YooTheme Zoo component
 * @category   JBZoo
 * @author     smet.denis <admin@joomla-book.ru>
 * @copyright  Copyright (c) 2009-2012, Joomla-book.ru
 * @license    http://joomla-book.ru/info/disclaimer
 * @link       http://joomla-book.ru/projects/jbzoo JBZoo project page
 */

(function ($) {
    $.ajaxSetup({
        headers:{ "cache-control":"no-cache" }
    });

    $.fn.JBZooBasket = function (options) {

        var options = $.extend({}, {
        }, options);

        return $(this).each(function () {

                var $obj = $(this);

                // recount basket
                var recount = function (data) {

                    for (var itemId in data.items) {
                        var subTotal = data.items[itemId];
                        $('.row-' + itemId + ' .jsSubtotal', $obj).text(subTotal);
                    }

                    $('.jsTotalCount', $obj).text(data.count);
                    $('.jsTotalPrice', $obj).text(data.total);
                };

                // remove one item
                $('.jsDelete', $obj).click(function () {

                    var $button = $(this),
                        itemid = $button.closest('tr').attr('itemid');

                    $.post(options.deleteUrl, {
                        'itemid':itemid
                    }, function (data) {
                        var $row = $button.closest('tr');
                        $row.find('td').slideUp(300, function () {
                            $row.remove();
                            if ($obj.find('tbody tr').length == 0) {
                                window.location.reload();
                            }
                        });
                        recount(data);
                        $.fn.JBZooPriceReloadBasket();
                    }, 'json');

                    return false;
                });

                // remove all
                $('.jsDeleteAll', $obj).click(function () {

                    var $button = $(this);

                    if (confirm(options.clearConfirm)) {
                        $.post(options.clearUrl, {}, function () {
                            window.location.reload();
                        });
                    }

                });

                // quantity
                var changeCallback = function () {

                    var $input = $(this),
                        value = parseInt($input.val(), 10),
                        itemid = parseInt($input.closest('tr').attr('itemid'), 10);

                    if ($input.val().length && value >= 0) {

                        $.post(options.quantityUrl, {
                                'value':value,
                                'itemId':itemid
                            },
                            function (data) {
                                recount(data);
                                $.fn.JBZooPriceReloadBasket();
                            },
                            'json'
                        );
                    }
                };

                $('.jsQuantity', $obj).change(changeCallback).keyup(changeCallback);

            }
        )
            ;
    };

})
    (jQuery);
